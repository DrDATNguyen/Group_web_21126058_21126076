{{!-- Flash Message --}}
{{#if successMessage}}
<div class="alert alert-success">{{successMessage}}</div>
{{/if}}

<div class="container">
    <!-- User Options -->
    <div class="user-options">
        <p>LOG OUT HERE <a href="/users/logout">Logout</a> | <a href="/users/register">Register</a></p>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter">
        <input type="text" id="searchBar" placeholder="Search by name or description..." 
               onkeydown="handleKeyDown(event)">
        <select id="filterCategory" onchange="filterProducts()">
            <option value="">All Categories</option>
            {{#each categories}}
            <option value="{{this.id}}">{{this.name}}</option>
            {{/each}}
        </select>
        <select id="filterPrice" onchange="filterProducts()">
            <option value="">All Prices</option>
            <option value="low">Below $50</option>
            <option value="medium">$50 - $100</option>
            <option value="high">Above $100</option>
        </select>
        <select id="filterAvailability" onchange="filterProducts()">
            <option value="">All Availability</option>
            <option value="inStock">In Stock</option>
            <option value="outOfStock">Out of Stock</option>
        </select>
    </div>

    <!-- Product List -->
    <h1 class="section-title">Product List</h1>
    <ul id="productList" class="product-list">
        {{#each products}}
        <li class="product-item">
            <div class="product-card">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="section-heading">
                                <h2>{{this.name}}</h2>
                                <span>{{this.Descriptions}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="men-item-carousel">
                                    <div class="owl-men-item owl-carousel">
                                        <div class="item">
                                            <div class="thumb">
                                                <div class="hover-content">
                                                    <ul>
                                                        <li><a href="/products/{{this.id}}"><i class="fa fa-eye"></i></a></li>
                                                        <li><a href="#"><i class="fa fa-star"></i></a></li>
                                                        <li><a href="#"><i class="fa fa-shopping-cart"></i></a></li>
                                                    </ul>
                                                </div>
                                                <img src="/assets/images/{{this.thumb}}" alt="{{this.name}}" class="product-thumb">
                                            </div>
                                            <div class="down-content">
                                                <h4>{{this.name}}</h4>
                                                <span>${{this.Price}}</span>
                                                <a href="/products/{{this.id}}" class="button">View Details</a>
                                                <ul class="stars">
                                                    <li><i class="fa fa-star"></i></li>
                                                    <li><i class="fa fa-star"></i></li>
                                                    <li><i class="fa fa-star"></i></li>
                                                    <li><i class="fa fa-star"></i></li>
                                                    <li><i class="fa fa-star"></i></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </li>
        {{/each}}
    </ul>
</div>

<script>
    async function filterProducts() {
        const searchQuery = document.getElementById('searchBar').value;
        const category = document.getElementById('filterCategory').value;
        const price = document.getElementById('filterPrice').value;
        const availability = document.getElementById('filterAvailability').value;

        console.log('Search Query:', searchQuery);
        console.log('Selected Category:', category);
        console.log('Price Range:', price);
        console.log('Availability:', availability);

        try {
            const url = `/api?searchQuery=${encodeURIComponent(searchQuery)}&category=${category}&price=${price}&availability=${availability}`;
            const response = await fetch(url);
            const products = await response.json();

            if (!Array.isArray(products)) {
                console.error('API did not return an array:', products);
                return;
            }

            const productList = document.getElementById('productList');
            productList.innerHTML = products.map(product => `
                <li class="product-item">
                    <div class="product-card">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="section-heading">
                                        <h2>${product.name}</h2>
                                        <span>${product.Descriptions}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="container">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="men-item-carousel">
                                            <div class="owl-men-item owl-carousel">
                                                <div class="item">
                                                    <div class="thumb">
                                                        <div class="hover-content">
                                                            <ul>
                                                                <li><a href="/products/${product.id}"><i class="fa fa-eye"></i></a></li>
                                                                <li><a href="#"><i class="fa fa-star"></i></a></li>
                                                                <li><a href="#"><i class="fa fa-shopping-cart"></i></a></li>
                                                            </ul>
                                                        </div>
                                                        <img src="/assets/images/${product.thumb}" alt="${product.name}" class="product-thumb">
                                                    </div>
                                                    <div class="down-content">
                                                        <h4>${product.name}</h4>
                                                        <span>$${product.Price}</span>
                                                        <a href="/products/${product.id}" class="button">View Details</a>
                                                        <ul class="stars">
                                                            <li><i class="fa fa-star"></i></li>
                                                            <li><i class="fa fa-star"></i></li>
                                                            <li><i class="fa fa-star"></i></li>
                                                            <li><i class="fa fa-star"></i></li>
                                                            <li><i class="fa fa-star"></i></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            `).join('');
        } catch (error) {
            console.error('Error fetching filtered products:', error);
        }
    }

    function handleKeyDown(event) {
        if (event.key === 'Enter') {
            filterProducts();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        filterProducts();
    });
</script>
